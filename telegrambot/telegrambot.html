<!-- Created by Karl-Heinz Wind -->


<!-- ------------------------------------------------------------------------------------------ -->
<script type="text/javascript">
    RED.nodes.registerType('telegram client config', {
        category: 'config',
        defaults: {
			botname: { value: "", required: true },
            verboselogging: { value: false, required: false },
        },
        credentials: {
		    apiid: { value: 0, required: true, validate:function(v) { return ((v === "") || (RED.validators.number(v) && (v >= 0) && (v <= 4294967295))) }},
            apihash: { value: "", required: true },
            session: { value: "", required: true, validate:function(v) { return v.length > 0;}},
	        phonenumber: { value: "", required: true },
            password: { value: "", required: false },
      	},
        label: function () {
            return this.botname;
        },
        oneditprepare: function() {
            var login = function() {       
                
                let apiId = $("#node-config-input-apiid").val();
                let apiHash = $("#node-config-input-apihash").val();
                let phoneNumber = $("#node-config-input-phonenumber").val();
                let password = $("#node-config-input-password").val();
                
                if (apiId !== '' && apiHash !== '' && phoneNumber !== '') {
                    let parameters = {
                        apiId : apiId,
                        apiHash : apiHash,
                        phoneNumber : phoneNumber,
                        password : password
                    }

                    $("#loginbuttontip").text("Login started: enter code in field below.");
                    $("#node-config-input-phonecode").val('');
                    $("#node-config-input-session").val('');
                    $.getJSON('node-red-node-telegrambot-loginuser', parameters, function(data) {
                        if(data.session){
                            debugger
                            $("#node-config-input-session").val(data.session);
                            $("#loginbuttontip").text("Click Login button to request code for login: code will be sent via your phone.");
                            $("#node-config-input-phonecode").val('');
                            $("#loginpanel").hide();
                        }
                        
                        if(data.error){
                            $("#node-config-input-session").val('');
                            $("#loginbuttontip").text("Login failed: " + data.error);
                        }
                    });
                }
            }

            var setPhoneCode = function() {  
                let phoneCode = $("#node-config-input-phonecode").val();
                if(phoneCode != ''){
                    $("#loginbuttontip").text("Signing in using phone code ....");
                    let parameters = {
                        phoneCode : phoneCode
                    }
                    $.getJSON('node-red-node-telegrambot-setphonecode', parameters, function(data) {
                        ; // TODO:
                    });
                }
            }

            var setPassword = function() {  
                let password = $("#node-config-input-password").val();
                if(password != ''){
                    $("#loginbuttontip").text("Signing in using password ....");
                    let parameters = {
                        password : password
                    }
                    $.getJSON('node-red-node-telegrambot-setpassword', parameters, function(data) {
                        ; // TODO:
                    });
                }
            }

            var showLoginButton = function() {  
                let session = $("#node-config-input-session").val();
                if(session === ''){
                    $("#loginpanel").show();
                }
                else
                {
                    $("#loginpanel").hide();
                }
            }

            // Entering the fields will not trigger anything: please use login button
            // $('#node-config-input-apiid').change(login);
            // $('#node-config-input-apihash').change(login);
            // $('#node-config-input-phonenumber').change(login);
      
            $('#node-config-input-phonecode').change(setPhoneCode);
            $('#node-config-input-password').change(setPassword);
            $('#node-config-input-session').change(showLoginButton);

            $( '#loginbutton' ).click( function() {
                login();    
            });

            showLoginButton();
        }
    });
</script>

<script type="text/x-red" data-template-name="telegram client config">
    <div class="form-row">
        <div class="form-row">
            <label for="node-config-input-botname"><i class="fa fa-telegram"></i> Name</label>
            <input type="text" id="node-config-input-botname" placeholder="(Name)">
        </div>

        <div class="form-row">
            <div class="form-row">
                <label for="node-config-input-phonenumber"><i class="fa fa-mobile"></i> Phone-Number</label>
                <input type="text" id="node-config-input-phonenumber" placeholder="(+49...)">
            </div>    
			<div class="form-row">
				<label for="node-config-input-apiid"><i class="fa fa-key"></i> ApiID</label>
				<input type="text" id="node-config-input-apiid" placeholder="(Enter the ID here)">
			</div>
            <div class="form-row">
                <label for="node-config-input-apihash"><i class="fa fa-hashtag"></i> ApiHash</label>
                <input type="text" id="node-config-input-apihash" placeholder="(Enter the hash here)">
            </div>
			<div class="form-tips" style="width: auto"><b>Tip:</b> If you don't have an application ID yet, you can create a new one here: <a href="https://my.telegram.org/auth">Telegram</a>.</div>
    	</div>
		
        <div class="form-row">
			<div class="form-row">
				<label for="node-config-input-session"><i class="fa fa-link"></i> Session</label>
				<input type="text" id="node-config-input-session" placeholder="(Enter the session here)">
			</div>
			<div class="form-tips" style="width: auto">
                <b>Tip:</b> If you don't have a session string yet, enter your phone code and password (if set) below. As an alternative you can create it online: <a href="https://tgsnake.js.org/login">Login</a>.</div>
    	</div>
	
        <div class="form-row hidden" id="loginpanel" style="background: var(--red-ui-tertiary-background)">
            <hr align="middle"/>        
            <div class="form-row">
                <input id='loginbutton' type='button' value=' Login ' style="width: auto"/></i></input>
                <div class="form-tips" id='loginbuttontip' style="width: auto">
                    Click Login button to request code for login: code will be sent via your phone.</div>
            </div>

            <div class="form-row">
                <label for="node-config-input-phonecode"><i class="fa fa-sign-in"></i> Phone-Code</label>
                <input type="text" id="node-config-input-phonecode" placeholder="(Enter phone code here)">
            </div>

            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
                <input type="text" id="node-config-input-password" placeholder="(Only needed if Two-Step-Verification is on)">
            </div>
            <hr align="middle"/>
        </div>

        <hr align="middle"/>

        <div class="form-row">
            <label for="node-config-input-verboselogging"><i class="fa fa-search"></i> Verbose Logging</label>
            <input type="checkbox" id="node-config-input-verboselogging" style="display: inline-block; width: auto; vertical-align: top;">
        </div>
        
        <div class="form-tips" style="width: auto"><b>Tip:</b> When verbose logging is turned on additional log messages will be printed to the node-red console.</div>

        <hr align="middle"/> 
    </div>
</script>

<script type="text/x-red" data-help-name="telegram client config">
    <p>A configuration node that holds the configuration of the telegram bot.</p>

    <h3>Details</h3>
    <p>TODO</p>
</script>



<!-- ------------------------------------------------------------------------------------------ -->
<script type="text/javascript">
    RED.nodes.registerType('telegram client receiver', {
        category: 'telegram',
        color: '#3BABDD',
        defaults: {
            name: { value: "" },
            bot: { value:"", type: "telegram client config", required: true }
        },
        inputs: 0,
        outputs: 1,
        icon: "telegram.png",
        paletteLabel: "client",
        label: function () {
            return this.name || "Telegram client";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
        }
    });
</script>

<script type="text/x-red" data-template-name="telegram client receiver">
    <div class="form-row">
        <label for="node-input-bot"><i class="fa fa-telegram"></i> Bot</label>
        <input type="text" id="node-input-bot" placeholder="Bot">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="telegram client receiver">
    <p>A telegram node that triggers the output when some message is received from the chat.</p>
    <p>The node receives all messages received from the telegram server.</p>
    
    <h3>Outputs</h3> 
    <p>1. Standard Ouput: Message is sent to output.</p>   
</script>

<!-- ------------------------------------------------------------------------------------------ -->

<script type="text/javascript">
    RED.nodes.registerType('telegram client sender', {
        category: 'telegram',
        color: '#3BABDD',
        defaults: {
            name: { value: "" },
            bot: { value:"", type: "telegram client config", required: true }
        },
        inputs: 1,
        outputs: 1,
        icon: "telegram.png",
        paletteLabel: "client",
        label: function () {
            return this.name || "Telegram client";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
        }
    });
</script>

<script type="text/x-red" data-template-name="telegram client sender">
    <div class="form-row">
        <label for="node-input-bot"><i class="fa fa-telegram"></i> Bot</label>
        <input type="text" id="node-input-bot" placeholder="Bot">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="telegram client sender">
    <p>A telegram node that sends messaged to a chat.</p>
    <p>The node receives data and sends it to the telegram server.</p>

    <h3>Inputs</h3> 
    <p>TODO:</p>   

    <h3>Inputs</h3> 
    <p></p>   
</script>

<!-- ------------------------------------------------------------------------------------------ -->
